<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="Assets/fontawesome-free-5.14.0-web/css/all.min.css">

    <title>Your Weather Dashboard!</title>
</head>

<body>

    <nav class="navbar navbar-dark bg-dark">
        <div class="col-sm-12 text-center h1" style="color: white;">Weather Dashboard</div>
        <!-- navbar-text mb-0-->
    </nav>

    <div class="row">
        <div class="col-sm-3">
            <span class="h4" style="margin-left: 10px;">Search for a City:</span>
            <form class="form-inline" style="margin-left: 10px; margin-top: 10px;">
                <input id="city-search" class="form-control mr-sm-2" type="search" placeholder="" aria-label="Search">
                <button id="btn-search" class="btn btn-primary " type="submit"><i class="fas fa-search"
                        style="color:white;"></i></button>
            </form>
            <div id="city-buttons" style="margin-left: 10px; margin-top: 20px;">
                <!-- <button type="button" class="btn btn-outline-secondary btn-lg btn-block text-left"
                    style="margin-top: -0px;">Austin</button> -->
                <!-- <button type="button" class="btn btn-outline-secondary btn-lg btn-block text-left"
                    style="margin-top: -0px;">Chicago</button>
                <button type="button" class="btn btn-outline-secondary btn-lg btn-block text-left"
                    style="margin-top: -0px;">New York</button>
                <button type="button" class="btn btn-outline-secondary btn-lg btn-block text-left"
                    style="margin-top: -0px;">Orlando</button> -->
            </div>
        </div>
        <div class="col-sm-9">
            <div class="row" style="margin-left: 20px;">
                <div class="card" style=" margin-top: 20px;">
                    <!--width: 100%; -->
                    <div class="card-body">
                        <span id="city-name" class="h2">Atlanta (8/15/2019)</span>
                        <img id="city-icon" src="Assets/weather-icons/sunny.png"
                            style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                        <p class="card-text">Temperature: <span id="city-temp">90.9 degF</span></p>
                        <p class="card-text">Humidity: <span id="city-humidity">41%</span></p>
                        <p class="card-text">Wind Speed: <span id="city-wind-speed">4.7 MPH</span></p>
                        <p class="card-text">UV Index: <span id="city-uv-index" class="badge badge-danger"
                                style="line-height: 20px; width: 40px; margin-bottom: 15px">9.49</span></p>

                    </div>
                </div>
            </div>
            <div class="row" style="margin-left: 20px;">
                <span class="h3" style="margin-top: 20px;">5-Day Forecast:</span>
            </div>
            <div class="row" style="margin-left: 20px;">
                <div class="card-deck">
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 id="day-one-date" class="card-title">8/16/2019</h5>
                            <img id="day-one-icon" src="Assets/weather-icons/sunny.png"
                                style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                            <p class="card-text">Temp: <span id="day-one-temp">86.84 degF</span></p>
                            <p class="card-text">Humidity: <span id="day-one-humidity">43%</span></p>
                        </div>
                    </div>
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 id="day-two-date" class="card-title">8/16/2019</h5>
                            <img id="day-two-icon" src="Assets/weather-icons/sunny.png"
                                style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                            <p class="card-text">Temp: <span id="day-two-temp">86.84 degF</span></p>
                            <p class="card-text">Humidity: <span id="day-two-humidity">43%</span></p>
                        </div>
                    </div>
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 id="day-three-date" class="card-title">8/16/2019</h5>
                            <img id="day-three-icon" src="Assets/weather-icons/sunny.png"
                                style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                            <p class="card-text">Temp: <span id="day-three-temp">86.84 degF</span></p>
                            <p class="card-text">Humidity: <span id="day-three-humidity">43%</span></p>
                        </div>
                    </div>
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 id="day-four-date" class="card-title">8/16/2019</h5>
                            <img id="day-four-icon" src="Assets/weather-icons/sunny.png"
                                style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                            <p class="card-text">Temp: <span id="day-four-temp">86.84 degF</span></p>
                            <p class="card-text">Humidity: <span id="day-four-humidity">43%</span></p>
                        </div>
                    </div>
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 id="day-five-date" class="card-title">8/16/2019</h5>
                            <img id="day-five-icon" src="Assets/weather-icons/sunny.png"
                                style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                            <p class="card-text">Temp: <span id="day-five-temp">86.84 degF</span></p>
                            <p class="card-text">Humidity: <span id="day-five-humidity">43%</span></p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>






    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script type="text/javascript">

        var recentCities = JSON.parse(localStorage.getItem("recentCities")); // array for populating the recent cities buttons

        function populateData(response) { // populate city name, date, temp, humidity, wind speed, and uv index
            var day = moment.unix(response.dt);
            $("#city-name").text(response.name + " (" + (day._d.getMonth() + 1) + "/" + day._d.getDate() + "/" + day._d.getFullYear() + ")");
            $("#city-temp").text(parseInt((response.main.temp - 273.15) * 9 / 5 + 32) + "Â°F"); // convert kelvin to F
            $("#city-humidity").text(parseInt(response.main.humidity) + "%");
            $("#city-wind-speed").text((response.wind.speed * 2.237).toFixed(1) + "MPH"); // meters per second * 2.237 = miles per hour
            $("#city-icon").attr("src", "http://openweathermap.org/img/wn/" + response.weather[0].icon + "@2x.png");
        }

        function populateCityButtons(storedRecentCities){
            // <button type="button" class="btn btn-outline-secondary btn-lg btn-block text-left"
            //         style="margin-top: -0px;">Austin</button>
            $("#city-buttons").empty();
            for (city of storedRecentCities){ // for each city in the input array
               var newButton = $("<button>").attr("type", "button").attr("class", "btn btn-outline-secondary btn-lg btn-block text-left").attr("style", "margin-top: 1px;" ).text(city);
                $("#city-buttons").append(newButton);
            }
        }

        function getCityData(citySearch) {
            //call ajax and retrieve weather data for city
            //display city data on dashboard
            var apiKey = "d85c0fa84df93dc9e2c51749f4580b7e";
            var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + citySearch + "&appid=d85c0fa84df93dc9e2c51749f4580b7e";
            $.ajax({
                url: queryURL,
                method: "GET"
            }).then(function (response) {
                //if response is good
                if (response.hasOwnProperty("name")) {
                    //localStorage.setItem(response.name, JSON.stringify(response));
                    populateData(response);
                    //display city weather quick buttons in button area
                    // get local storage version of recent cities
                    var storedRecentCities = JSON.parse(localStorage.getItem("recentCities"));
                    //prepend the name of the city from this ajax call
                    if(storedRecentCities === null){// if no locally stored values, set to empty array
                        storedRecentCities = [];
                    }
                    storedRecentCities.unshift(response.name); //prepend the most recent response to the begining of the recent cities array
                    // fun hashtable implmentation from https://stackoverflow.com/questions/9229645/remove-duplicate-values-from-js-array
                    //filter the array of recent cities for duplicates
                    var seen = {};
                    storedRecentCities = storedRecentCities.filter(function (item) {
                        return seen.hasOwnProperty(item) ? false : (seen[item] = true);
                    });
                    //store recent cities back in local storage
                    localStorage.setItem("recentCities", JSON.stringify(storedRecentCities)); 
                    populateCityButtons(storedRecentCities); // draw city buttons

                    //get UV index info
                    var queryURL = "https://api.openweathermap.org/data/2.5/uvi?appid=" +apiKey+ "&lat="+response.coord.lat+"&lon="+response.coord.lon;
                    $.ajax({
                        url: queryURL,
                        method: "GET"
                    }).then(function(response){
                        $("#city-uv-index").text(response.value);
                        if(response.value >= 8){
                            $("#city-uv-index").attr("class", "badge badge-danger");
                        }else if(response.value > 3){
                            $("#city-uv-index").attr("class", "badge badge-warning");
                        }else {
                            $("#city-uv-index").attr("class", "badge badge-sucess");
                        }
                    });
                }
            });



        }
        // function getCityData(citySearch) {
        //     var storedCityData = JSON.parse(localStorage.getItem(citySearch));
        //     if (!(storedCityData === null)) {//is there a stored record in city?
        //         var storedDate = moment.unix(storedCityData.dt); // get stored data time
        //         var currentDate = moment.utc(); // get current utc time
        //         if (currentDate.diff(storedDate, "minutes") <= 10) { //find the difference in minutes between the stored data time stamp and the current time
        //             //if data is less than 10 minutes old, use the stored data
        //             populateData(storedCityData); // populate the dashboard with stored city data
        //             return;
        //         }
        //     }
        //     //program pointer will reach this point if no data exist locally, or if the data is older than 10 min
        //     //therfore, call new data
        //     var apiKey = "d85c0fa84df93dc9e2c51749f4580b7e";
        //     var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + citySearch + "&appid=d85c0fa84df93dc9e2c51749f4580b7e";
        //     $.ajax({
        //         url: queryURL,
        //         method: "GET"
        //     }).then(function (response) {
        //         console.log("AJAX RESPONSE");
        //         console.log(response);
        //         //if response is good
        //         if (response.hasOwnProperty("name")) {
        //             localStorage.setItem(response.name, JSON.stringify(response));
        //             populateData(response);

        //         }
        //     });
        // }

        //run this every time the page loads - either pull up most recent city, or default city
        if(recentCities === null){
            getCityData("Atlanta");
        }else{
            getCityData(recentCities[0]);
        }

        $("#btn-search").on("click", function (event) { // on search submit
            event.preventDefault();
            var citySearch = $("#city-search").val().trim().toLowerCase();//trim and set to lower case for consistency 
            if (citySearch != "") {
                getCityData(citySearch); // get city data
            }
        })

        $("#city-buttons").on("click", function(event){ // on city quick button
            event.preventDefault();
            getCityData(event.target.innerHTML.toLowerCase()); // get city data
        });


    </script>
</body>

</html>