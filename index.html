<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="Assets/fontawesome-free-5.14.0-web/css/all.min.css">
    <style>
        .uv-extreme {
            background-color: fuchsia;
        }

        .uv-very-high {
            background-color: red;
        }

        .uv-high {
            background-color: orange;
        }

        .uv-moderate {
            background-color: yellow;
        }

        .uv-low {
            background-color: greenyellow;
        }
    </style>
    <title>Your Weather Dashboard!</title>
</head>

<body>

    <nav class="navbar navbar-dark bg-dark">
        <div class="col-sm-12 text-center h1" style="color: white;">Weather Dashboard</div>
        <!-- navbar-text mb-0-->
    </nav>

    <div class="row">
        <div class="col-sm-3">
            <span class="h4" style="margin-left: 10px;">Search for a City:</span>
            <form class="form-inline" style="margin-left: 10px; margin-top: 10px;">
                <input id="city-search" class="form-control mr-sm-2" type="search" placeholder="" aria-label="Search">
                <button id="btn-search" class="btn btn-primary " type="submit"><i class="fas fa-search"
                        style="color:white;"></i></button>
            </form>
            <div id="city-buttons" style="margin-left: 10px; margin-top: 20px;">
                <!-- <button type="button" class="btn btn-outline-secondary btn-lg btn-block text-left"
                    style="margin-top: -0px;">Austin</button> -->
                <!-- <button type="button" class="btn btn-outline-secondary btn-lg btn-block text-left"
                    style="margin-top: -0px;">Chicago</button>
                <button type="button" class="btn btn-outline-secondary btn-lg btn-block text-left"
                    style="margin-top: -0px;">New York</button>
                <button type="button" class="btn btn-outline-secondary btn-lg btn-block text-left"
                    style="margin-top: -0px;">Orlando</button> -->
            </div>
        </div>
        <div class="col-sm-9">
            <div class="row" style="margin-left: 20px;">
                <div class="card" style=" margin-top: 20px;">
                    <!--width: 100%; -->
                    <div class="card-body">
                        <span id="city-name" class="h2">Atlanta (8/15/2019)</span>
                        <img id="city-icon" src="Assets/weather-icons/sunny.png"
                            style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                        <p class="card-text">Temperature: <span id="city-temp">90.9 degF</span></p>
                        <p class="card-text">Humidity: <span id="city-humidity">41%</span></p>
                        <p class="card-text">Wind Speed: <span id="city-wind-speed">4.7 MPH</span></p>
                        <p class="card-text">UV Index: <span id="city-uv-index" class="badge badge-danger"
                                style="line-height: 20px; width: 40px; margin-bottom: 15px">9.49</span></p>

                    </div>
                </div>
            </div>
            <div class="row" style="margin-left: 20px;">
                <span class="h3" style="margin-top: 20px;">5-Day Forecast:</span>
            </div>
            <div class="row" style="margin-left: 20px;">
                <div class="card-deck">
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 id="day-0-date" class="card-title">8/16/2019</h5>
                            <img id="day-0-icon" src="Assets/weather-icons/sunny.png"
                                style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                            <p class="card-text">Temp: <span id="day-0-temp">86.84 degF</span></p>
                            <p class="card-text">Humidity: <span id="day-0-humidity">43%</span></p>
                        </div>
                    </div>
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 id="day-1-date" class="card-title">8/16/2019</h5>
                            <img id="day-1-icon" src="Assets/weather-icons/sunny.png"
                                style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                            <p class="card-text">Temp: <span id="day-1-temp">86.84 degF</span></p>
                            <p class="card-text">Humidity: <span id="day-1-humidity">43%</span></p>
                        </div>
                    </div>
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 id="day-2-date" class="card-title">8/16/2019</h5>
                            <img id="day-2-icon" src="Assets/weather-icons/sunny.png"
                                style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                            <p class="card-text">Temp: <span id="day-2-temp">86.84 degF</span></p>
                            <p class="card-text">Humidity: <span id="day-2-humidity">43%</span></p>
                        </div>
                    </div>
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 id="day-3-date" class="card-title">8/16/2019</h5>
                            <img id="day-3-icon" src="Assets/weather-icons/sunny.png"
                                style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                            <p class="card-text">Temp: <span id="day-3-temp">86.84 degF</span></p>
                            <p class="card-text">Humidity: <span id="day-3-humidity">43%</span></p>
                        </div>
                    </div>
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 id="day-4-date" class="card-title">8/16/2019</h5>
                            <img id="day-4-icon" src="Assets/weather-icons/sunny.png"
                                style="height: 50px; width: 50px; margin-top: 10px; margin-bottom: 20px;"></img>
                            <p class="card-text">Temp: <span id="day-4-temp">86.84 degF</span></p>
                            <p class="card-text">Humidity: <span id="day-4-humidity">43%</span></p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>






    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script type="text/javascript">

        // global vars
        var recentCities = JSON.parse(localStorage.getItem("recentCities")); // array for populating the recent cities buttons


        function populateData(response) { // populate city name, date, temp, humidity, wind speed, and uv index        
            var day = moment.unix(response.dt); // get response's unix utc time
            day.add(response.timezone, 'seconds'); // add the timezone offset from the openweather map reponse to get current local date
            $("#city-name").text(response.name + " (" + (day._d.getMonth() + 1) + "/" + day._d.getDate() + "/" + day._d.getFullYear() + ")");
            $("#city-temp").text(((response.main.temp - 273.15) * 9 / 5 + 32).toFixed(1) + "°F"); // convert kelvin to F
            $("#city-humidity").text(parseInt(response.main.humidity) + "%");
            $("#city-wind-speed").text((response.wind.speed * 2.237).toFixed(1) + "MPH"); // meters per second * 2.237 = miles per hour
            $("#city-icon").attr("src", "http://openweathermap.org/img/wn/" + response.weather[0].icon + "@2x.png");
        }


        function populateUV(oneCall) { // populate and style current UV index
            $("#city-uv-index").text(oneCall.current.uvi);
            if (oneCall.current.uvi >= 11) {// extreme
                $("#city-uv-index").attr("class", "badge uv-extreme"); // purple
            } else if (oneCall.current.uvi >= 8) {// very high
                $("#city-uv-index").attr("class", "badge uv-very-high"); // red
            } else if (oneCall.current.uvi >= 6) {// high
                $("#city-uv-index").attr("class", "badge uv-high"); // orange
            } else if (oneCall.current.uvi >= 3) {// moderate
                $("#city-uv-index").attr("class", "badge uv-moderate"); // yellow
            } else {// low 
                $("#city-uv-index").attr("class", "badge uv-low"); // green
            }
        }

        function populate5Day(oneCall) {// populate info for the 5 day forecast
            //next 5 day forecast

            var dailyForecasts = oneCall.daily;
            var currentTime = moment();
            var fcTime = moment.unix(dailyForecasts[0].dt);
            var forecastOffset = 0;
            if (currentTime._d.getDate() == fcTime._d.getDate()) {
                forecastOffset = 1;
            } else {
                forecastOffset = 0;
            }

            for (var i = 0; i <= 4; i++) {//loop through each day's forecast and populate
                var forecast = dailyForecasts[i + forecastOffset];
                var date = moment.unix(forecast.dt); // get moment date object //removed i -1

                date.add(oneCall.timezone_offset, 'seconds'); // add/substract the timezone offset to get local time
                //moment object .getMonth() returns a number 0-11 cooresponding to the current month
                $("#day-" + i + "-date").text((date._d.getMonth() + 1) + "/" + date._d.getDate() + "/" + date._d.getFullYear());
                //openweathermap provides icons for current weather conditions
                $("#day-" + i + "-icon").attr("src", "http://openweathermap.org/img/wn/" + forecast.weather[0].icon + "@2x.png"); // del i-1
                // temp forecast is given in Kelvin: conversion is K - 273.15 * 9/5 + 32
                $("#day-" + i + "-temp").text(((forecast.temp.day - 273.15) * 9 / 5 + 32).toFixed("2") + "°F"); // del i -1
                $("#day-" + i + "-humidity").text(forecast.humidity + "%");// del i -1

            }
        }

        function populateCityButtons(cityName) {
            //display city weather quick buttons in button area
            // get local storage version of recent cities
            RecentCities = JSON.parse(localStorage.getItem("recentCities"));
            //prepend the name of the city from this ajax call
            if (RecentCities === null) {// if no locally stored values, set to empty array
                RecentCities = [];
            }
            RecentCities.unshift(cityName); //prepend the most recent response to the begining of the recent cities array
            // fun hashtable implmentation from https://stackoverflow.com/questions/9229645/remove-duplicate-values-from-js-array
            //filter the array of recent cities for duplicates
            var seen = {};
            RecentCities = RecentCities.filter(function (item) {
                return seen.hasOwnProperty(item) ? false : (seen[item] = true);
            });
            //store recent cities back in local storage
            localStorage.setItem("recentCities", JSON.stringify(RecentCities));
            // <button type="button" class="btn btn-outline-secondary btn-lg btn-block text-left"
            //         style="margin-top: -0px;">Austin</button>
            $("#city-buttons").empty();
            for (city of RecentCities) { // for each city in the input array
                var newButton = $("<button>").attr("type", "button").attr("class", "btn btn-outline-secondary btn-lg btn-block text-left").attr("style", "margin-top: 1px;").text(city);
                $("#city-buttons").append(newButton);
            }
        }

        function getCityData(citySearch) {
            // determine if there is recent data (< 10 min old) for requested data stored locally
            var storedCityInfo = JSON.parse(localStorage.getItem(citySearch + "-info"));
            if (storedCityInfo != null) { // if there is an entry for the city
                //check the age of the info
                var storedTime = moment.unix(storedCityInfo.dt);
                var currentTime = moment();
                //console.log("Age of data: " + currentTime.diff(storedTime, 'minutes'));
                if (currentTime.diff(storedTime, 'minutes') <= 10) {
                    var storedOneCallData = JSON.parse(localStorage.getItem(citySearch + "-onecall"));
                    if (storedOneCallData != null) {
                        //if stored data exists and is recent
                        populateData(storedCityInfo);
                        populateCityButtons(storedCityInfo.name);
                        populateUV(storedOneCallData);
                        populate5Day(storedOneCallData);
                        return; // return to avoid unnecessary ajax calls
                    }
                }// else // make a new ajax request for more recent data
            } // else if no entry, make a new ajax request for more recent data

            //call ajax and retrieve weather data for city
            //display city data on dashboard
            var apiKey = "d85c0fa84df93dc9e2c51749f4580b7e";
            var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + citySearch + "&appid=d85c0fa84df93dc9e2c51749f4580b7e";
            $.ajax({
                url: queryURL,
                method: "GET"
            }).then(function (response) {
                //if response is good
                if (response.hasOwnProperty("name")) {

                    populateData(response); // populate current weather fields
                    populateCityButtons(response.name); // draw city buttons

                    //use lat and lon from current weather ajax call to get onecall info for UV index and 5 day forcast 
                    //"https://api.openweathermap.org/data/2.5/onecall?lat={lat}&lon={lon}&appid={YOUR API KEY}"
                    var queryURL = "https://api.openweathermap.org/data/2.5/onecall?lat=" + response.coord.lat + "&lon=" + response.coord.lon + "&appid=" + apiKey;
                    $.ajax({
                        url: queryURL,
                        method: "GET"
                    }).then(function (oneCall) {
                        if (oneCall.hasOwnProperty("current")) {
                            populateUV(oneCall); // populate day UV index
                            populate5Day(oneCall); // populate 5 day area

                            //store openWeatherMap responses for later use
                            localStorage.setItem(citySearch.toLowerCase() + "-info", JSON.stringify(response));
                            localStorage.setItem(citySearch.toLowerCase() + "-onecall", JSON.stringify(oneCall));
                        }
                    });
                }
            });
        }

        //
        //run this every time the page loads - either pull up most recent city, or default city
        //
        if (recentCities === null) {
            getCityData("Atlanta");
        } else {
            getCityData(recentCities[0]);
        }

        $("#btn-search").on("click", function (event) { // on search submit
            event.preventDefault();
            var citySearch = $("#city-search").val().trim().toLowerCase();//trim and set to lower case for consistency 
            if (citySearch != "") {
                getCityData(citySearch); // get city data
            }
        })

        $("#city-buttons").on("click", function (event) { // on city quick button
            event.preventDefault();
            getCityData(event.target.innerHTML.toLowerCase()); // get city data
        });


    </script>
</body>

</html>